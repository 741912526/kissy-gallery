KISSY.add("gallery/grid/1.0/editGrid",function(d,e,h){var n=d.DOM,k=d.UA,p=d.Node;var b="data-column-name",j="row-element",i="grid-body-cell-text",c="grid-body-cell",g="grid-body-cell-inner",l="col",f="lp-editor-field",r="grid-editable-cell",o="grid-error-cell",a="grid-cell-error-icon",q="grid-body-td-";function m(s){m.superclass.constructor.call(this,s)}d.extend(m,e,{clearError:function(){var t=this,s=false,u=t.get("showError"),w=null,v=null;if(u){}t.cancelEdit()},cancelEdit:function(){var s=this,t=s.get("columns");d.each(t,function(v){var u=v.editor;if(u&&!u.isHide()){u.hide()}})},hasError:function(){var t=this,s=false,u=t.get("showError"),w=null,v=null;if(u){v=t.get("tbody");s=!!d.one(v).one("."+o)}if(!s){w=t.get("columns");d.each(w,function(y){var x=y.editor;if(x&&!x.isHide()&&x.hasError()){s=true;return false}})}return s},setCellToEdit:function(u,w){var t=this,s=t._getCell(u,w),v=t._getEditor(w);if(n.hasClass(s,r)){t._showEditor(v,s,u[w],u)}},_attachEditEvent:function(u){var s=this,t=u.editor;t.on("change",s._getChangeEvent(u));t.on("hide",function(v){s.set("editRecord",null);s.set("editor",null)})},_getChangeEvent:function(t){var s=this;return function(w){var x=w.value,u=w.record,y=t.dataIndex,v=s.get("store");if(u[y]!==x){v.setValue(u,y,x)}}},_addError:function(s,v){var u=s.one("."+g),w=s.one("."+a),t=['<span class="',a,'" title="',v,'"></span>'].join("");if(!w){u.addClass(o);w=new p(t).appendTo(u)}else{w.attr("title",v)}},_clearError:function(s){var t=s.one("."+g),u=s.one("."+a);t.removeClass(o);if(u){u.remove()}},_getEditor:function(t){var s=this;columns=s.get("columns"),editor=null;d.each(columns,function(u){if(u.dataIndex===t){editor=u.editor;return false}});return editor},_getCellTemplate:function(t,w,H,F,y){var D=this,E=w.dataIndex,u=w.width,C=w.showTip?'title = "'+(F||"")+'"':"",z=w.hide?"ks-hidden":"",B=w.editor,s=B?(B.editableFun&&!B.editableFun(F,y)?"":r):"",x=D.get("showError"),I=x?(B&&B.validator?B.validator(F,y):""):"",A=I?'<span class="'+a+'" title="'+I+'"></span>':"",v=I?o:"",G=['<td  class="grid-body-cell grid-body-td-',E," ",z," ",s,'" data-column-name="',E,'" colindex="',t,'" width="',u,'px">','<div class="',g," ",v,'" style="width : ',u,'px"><span class="',i,' " ',C,">",H,"</span>",A,"</div></td>"].join("");return G},_getTextEditorTemplate:function(t){t=t||80;var s=['<div class="lp-text-editor grid-editor" style="position : absolute; z-index : 1000; visibility : hidden; left : -10000px; top : -10000px; overflow : auto;">','<input type="text" name=""autocomplete="off" size="20" class="lp-form-text-field lp-editor-field" style="width : ',t,'px; height : 20px;">'].join("");return s},_getRowDataByCell:function(t){var s=this,v=s._findRow(t),u=n.data(v,j);return u},_getCell:function(v,w){var t=this,x=t._findRowByRecord(v),u=q+w,s=d.one("."+u,x);return s},_getCellValue:function(t,w){var s=this,x=s._findRow(t),v=n.data(x,j),u=v?v[w]:null;return u},_hasEditor:function(s){return this.hasAttr(l+s)},_hideEditor:function(s){s.css({visibility:"hidden",left:-10000,top:-10000})},_init:function(){m.superclass._init.call(this);var s=this,t=s.get("columns");d.each(t,function(w){var v=w.editor,u=null;if(!v||v.isEditor){return}u=h.types[v.type||"text"];w.editor=new u(v);s._attachEditEvent(w)})},_initEvent:function(){var s=this;d.Event.on(document,"click",function(w){var v=s.get("editor"),u=w.target,t=s._findCell(w.target);if(!t&&v&&!v.isHide()&&!v.hasError()&&!v.isContains(u)){v.hide()}});s.constructor.superclass._initEvent.call(s)},_initDataEvent:function(){var s=this,t=s.get("store");t.on("updaterecord",function(v){var u=v.record;s._setRowValue(u)});s.on("rowremoved",function(w){var u=s.get("editRecord"),v=s.get("editor");if(u&&v){if(u==w.data&&!v.isHide()){v.hide()}}});s.constructor.superclass._initDataEvent.call(this)},_rowClickEvent:function(z){var u=this,t=u._findCell(z),y=null,w=null,x=null,v=null;if(t){y=n.attr(t,b);w=u._getEditor(y);x=u.get("editor");if(x&&x!=w){if(!x.isHide()&&!x.hasError()){x.hide()}}if(y&&w){if(!w.isHide()&&w.hasError()){w._focus();return}v=u._getRowDataByCell(t);if(v){if(!n.hasClass(t,r)){return}var s=u.fire("beforeedit",{cell:t,field:y,data:v});if(s!==false){u._showEditor(w,t,v[y],v)}}return}}u.constructor.superclass._rowClickEvent.call(this,z)},_setRowValue:function(u){var s=this,v=s._findRowByRecord(u),t=s.get("columns");if(v){d.each(t,function(w){var z=w.dataIndex,C=q+z,A=d.one("."+C,v),E=A.one("."+i),y=w.editor,D=y&&y.validator?y.validator(u[z],u):"",B=null,x=s.get("showError");if(E){B=w.renderer?w.renderer(u[z],u):u[z];B=B===undefined?"":B;E.html(B);if(!x){return}if(D){s._addError(A,D)}else{s._clearError(A)}}})}},_showEditor:function(v,z,y,w){var x=this,u=n.offset(z),s=n.width(z),B=n.get("."+g,z),A=n.height(B),t=x.get("editor");if(t&&!t.isHide()&&!t.hasError()){t.hide()}x.set("editRecord",w);x.set("editor",editor);if(k.ie==7){v.setWidth(s-4)}else{v.setWidth(s-2)}v.setValue(y,w);v.show({container:B,left:0,top:2})}});d.namespace("LP");d.LP.EditGrid=m;return m},{requires:["./grid","./gridEditor"]});KISSY.add("gallery/grid/1.0/gridEditor",function(d){var m=d.DOM,f=d.UA,g=d.Node;var a="grid-error-editor",j="grid-error-editor-icon";var i=function(o){var n=this;o=d.merge({isEditor:true},o);d.mix(n,o);i.superclass.constructor.call(n,o);n._init();n.events=["beforechange","change"]};d.extend(i,d.Base);d.augment(i,{CHANGE_EVENT:"blur",INIT_VALUE:"",hasError:function(){var n=this,o=n.get("el");return o.hasClass(a)},hide:function(){var n=this,o=n.get("el");n._clearError();o.css({visibility:"hidden",left:-10000,top:-10000});n.fire("hide",{record:n.get("record"),editor:n});n._setValue(n.INIT_VALUE);d.one("body").append(o)},getValue:function(){var n=this,o=n.get("editEl");return o?n._getValue():n.INIT_VALUE},isHide:function(){var n=this,o=n.get("el");return o.css("visibility")==="hidden"||o.width()==0},isContains:function(o){var n=this,p=n.get("el");return p.contains(o)},setValue:function(p,o){var n=this;n.set("record",o);if(editEl){n._setValue(p);n._validate(p,o)}},show:function(q){var n=this,p=n.get("el"),o=q.container;if(o){d.one(o).append(p)}p.css({visibility:"visible",left:q.left,top:q.top});n._focus();n.fire("show",{record:n.get("record"),editor:n})},setWidth:function(p){var n=this,o=n.get("editEl");o.width(p)},setHeight:function(o){var n=this,p=n.get("editEl");p.height(o)},_basicValidator:function(o,p){var n=this;if(n.required&&(o===undefined||o===null||d.trim(o.toString())==="")){return"不能为空"}return""},_basicFormat:function(n){if(n===undefined||d.trim(n.toString())===""){return undefined}return n},_clearError:function(){var n=this,o=n.get("el"),p=o.one("."+j);o.removeClass(a);p.attr("title","")},_focus:function(){var n=this,o=n.get("editEl");o[0].focus()},_getTemplate:function(){var n=['<input type="text" name=""autocomplete="off" size="20" class="lp-form-text-field lp-editor-field"  style="height : 20px;">','<s class="',j,'"></s>'].join("");return n},_getEditElemnt:function(){var n=this,p=n.get("el"),o=p.children();if(o.length){return d.one(o[0])}return null},_getValue:function(o){var n=this;o=o||n.get("editEl");return o.val()},_init:function(){var n=this;n._initDom();n._initEvent();n._initHideEvent()},_initDom:function(){var n=this,q=null,p=['<div class="grid-editor" style="position : absolute; z-index : 1000; visibility : hidden; left : -10000px; top : -10000px; overflow : auto;">',n._getTemplate(),"</div>"].join(""),o=n.get("container")||m.get("body");q=new g(p).appendTo(o);n.set("container",o);n.set("el",q);editEl=n._getEditElemnt();n.set("editEl",editEl)},_initEvent:function(){var n=this,p=n.get("el"),o=n.get("editEl");p.on("click",function(q){q.stopPropagation()});o.on(n.CHANGE_EVENT,function(s){var q=d.one(this),r=n._valueChange(q);if(!r){s.preventDefault()}else{}})},_initHideEvent:function(){},_valueChange:function(p,r){var n=this,o=n.get("record"),q=null;r=r||n._getValue(p);q=n._validate(r,o);r=n._basicFormat(r);r=n.format?n.format(r):r;if(q){n.fire("change",{value:r,record:o});return true}return false},_setError:function(p){var n=this,o=n.get("el"),q=o.one("."+j);o.addClass(a);q.attr("title",p)},_setValue:function(p,o){var n=this;o=o||n.get("editEl");o.val(p)},_validate:function(q,r){var o=this,n=null,p=true;n=o._basicValidator(q)||(o.validator&&o.validator(q,r));p=n?false:true;if(p){o._clearError()}else{o._setError(n)}return p},destroy:function(){var n=this,o=n.get("el");o.remove();n.detach();n.__attrVals={}}});var k=function(n){k.superclass.constructor.call(this,n)};d.extend(k,i);d.augment(k,{});var c=function(n){c.superclass.constructor.call(this,n)};d.extend(c,i);d.augment(c,{_basicFormat:function(n){if(n===undefined||d.trim(n.toString())===""){return undefined}return parseFloat(n)},_basicValidator:function(n){var o=this.constructor.superclass._basicValidator.call(this,n);if(!o&&n&&isNaN(n)){o="请输入数字"}return o}});var b=function(n){b.superclass.constructor.call(this,n)};d.extend(b,i);d.augment(b,{CHANGE_EVENT:"change",INIT_VALUE:false,setHeight:function(n){return},_getTemplate:function(){var n=['<input type="checkbox" name="" class="lp-form-checkbox-field lp-editor-field"  style="height : 20px;">','<s class="',j,'"></s>'].join("");return n},_getValue:function(o){o=o||this.get("editEl");var n=this,p=o.attr("checked");return p?true:false},_setValue:function(p,o){var n=this;o=o||n.get("editEl");o.attr("checked",p)}});var e=function(n){e.superclass.constructor.call(this,n)};d.extend(e,i);d.augment(e,{_getTemplate:function(){var n=['<select class="lp-form-select-field lp-editor-field"  style="height : 20px;"></select>','<s class="',j,'"></s>'].join("");return n},_initDom:function(){this.constructor.superclass._initDom.call(this);var n=this,p=n.get("editEl"),o=n.items;if(!n.required){n._createItem("请选择",n.INIT_VALUE,p)}if(d.isArray(o)){d.each(o,function(r){n._createItem(r.name,r.value,p)})}else{for(var q in o){if(o.hasOwnProperty(q)){n._createItem(o[q],q,p)}}}},_createItem:function(p,q,n){var o='<option value="'+q+'">'+p+"</option>";new g(o).appendTo(n)}});var h=function(n){h.superclass.constructor.call(this,n)};d.extend(h,i);d.augment(h,{CHANGE_EVENT:"select",isContains:function(o){var n=this;return n.constructor.superclass.isContains.call(this,o)||d.one(o).parent(".ks-cal-box")},setHeight:function(){return},setWidth:function(n){this.constructor.superclass.setWidth.call(this,n-15)},_basicFormat:function(n){return new Date(n).getTime()},_getTemplate:function(){var n=['<input type="text" name=""autocomplete="off" size="20" class="lp-form-text-field lp-editor-field"  style="height : 20px;">','<s class="',j,'"></s>'].join("");return n},_init:function(){var n=this;d.use("gallery/grid/1.0/calendar",function(o,p){n.set("Calendar",p);n.constructor.superclass._init.call(n)})},_initDom:function(){this.constructor.superclass._initDom.call(this);var n=this,o=n.get("editEl"),q=n.get("Calendar"),r="grid-date"+d.guid(),p=null;o.attr("id",r);p=new q([{selector:"#"+r}]);n.set("datepicker",p["#"+r])},_initEvent:function(){var n=this,q=n.get("datepicker"),p=n.get("el"),o=n.get("editEl");o.on("change",function(){d.log("change")});q.on(n.CHANGE_EVENT,function(s){var r=n._valueChange(null,s.date);if(r){}})},_setValue:function(r,p){var n=this,p=p||n.get("editEl"),o=d.LP.Format.dateRenderer(r),q=n.get("datepicker");p.val(o);if(r&&r!==n.INIT_VALUE){q.render({selected:new Date(r),date:new Date(r)})}},_getValue:function(o){var n=this;if(o){return o.date}else{d.log("error")}}});var l=function(n){l.superclass.constructor.call(this,n)};d.extend(l,i);d.augment(l,{hide:function(){var n=this,o=n.get("hideEvent");if(n._isSelectShow()){n._hideSelect()}n.constructor.superclass.hide.call(this)},isContains:function(o){var n=this;return n.constructor.superclass.isContains.call(this,o)||d.one(o).parent(".lp-multiple-wrap")},setValue:function(p,o){var n=this;p=p||[];n.constructor.superclass.setValue.call(this,p,o)},setWidth:function(n){this.constructor.superclass.setWidth.call(this,n-17)},setHeight:function(){return},_createItem:function(q,p,n){var o='<li class="multiple-item"> <input class="multiple-item-checkbox"  type="checkbox" name="'+p+'" />'+q+"</li>";new g(o).appendTo(n)},_getSelectOffset:function(){var n=this,o=n.get("editEl"),p=o.offset();p.top+=o.height()+2;return p},_getText:function(q){var n=this,q=q||n._getValue(),o=n.items,p=n.get("renderer");if(!p){p=d.LP.Format.multipleItemsRenderer(o);n.set("renderer",p)}return p(q)},_getValue:function(){var n=this,p=[],q=n.get("listEl"),o=q.all(".multiple-item-checkbox");d.each(o,function(r){if(r.checked){p.push(r.name)}});return p},_getTemplate:function(){var n=['<input type="text" readonly = "true" name=""autocomplete="off" size="20" class="lp-form-multiple-field lp-editor-field"  style="height : 20px;">','<s class="',j,'"></s>'].join("");return n},_hideSelect:function(){var n=this,o=n.get("selectEl");o.css({visibility:"hidden",left:-10000,top:-10000})},_isSelectShow:function(){var n=this,o=n.get("selectEl");return o.css("visibility")!=="hidden"&&o.width()!=0},_initDom:function(o){this.constructor.superclass._initDom.call(this);var u=this,r=u.get("editEl"),t=u.get("items"),v='<div class="lp-multiple-wrap"  style="position : absolute; z-index : 1200; visibility : hidden; left : -10000px; top : -10000px; overflow : auto;"><ul class="multiple-list ks-clear"></ul><div class="multiple-footer" style="text-align:center"><span class="x-btn x-btn-default-small"><button autocomplete="off" hidefocus="true" type="button" style="width:74px;"><span class="x-btn-inner">确认</span></button></span></div></div>',p=new g(v).appendTo("body"),s=p.one(".multiple-list"),q=p.one("button");u.set("selectEl",p);u.set("listEl",s);u.set("btnEl",q);if(d.isArray(t)){d.each(t,function(w){u._createItem(w.name,w.value,s)})}else{for(var n in t){if(t.hasOwnProperty(n)){u._createItem(t[n],n,s)}}}},_initEvent:function(){var n=this,q=n.get("listEl"),o=n.get("editEl"),p=n.get("btnEl");o.on("click",function(r){r.stopPropagation();n._toggleSelect()});q.on("click",function(r){r.stopPropagation()});p.on("click",function(r){r.stopPropagation();var s=n.getValue();n._setText(n._getText(s));n._hideSelect();n._valueChange(o,s)})},_setText:function(p){var n=this,o=n.get("editEl");o.val(p)},_setSelectValue:function(p){var n=this,q=n.get("listEl"),o=q.all(".multiple-item-checkbox");o.attr("checked",false);var r=d.filter(o,function(s){return d.inArray(s.name,p)});d.all(r).attr("checked","checked")},_setValue:function(o){var n=this,p=n._getText(o);n._setText(p);n._setSelectValue(o)},_showSelect:function(o){var n=this,p=n.get("selectEl"),o=o||n._getSelectOffset();p.css({visibility:"visible",left:o.left,top:o.top})},_toggleSelect:function(){var n=this;if(n._isSelectShow()){n._hideSelect()}else{n._showSelect()}}});i.types={text:k,number:c,check:b,select:e,date:h,multipleSelect:l};return i},{requires:[]});