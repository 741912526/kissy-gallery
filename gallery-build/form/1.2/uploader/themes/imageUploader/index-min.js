/**
 * @fileoverview 图片上传主题（带图片预览），第一版由紫英同学完成，苏河同学做了大量优化，明河整理优化
 * @author 苏河、紫英、明河
 **/KISSY.add("gallery/form/1.2/uploader/themes/imageUploader/index",function(a,b,c){function f(a){var b=this;f.superclass.constructor.call(b,a)}var d="",e=b.all;return a.extend(f,c,{afterUploaderRender:function(){var a=this,b=a.get("queue");a._renderFiledrop(),b.on("add",a._addFileHandler,a)},_addFileHandler:function(a){var b=this,c=a.file,d=c.target,f=e(".J_Del_"+c.id),g=e(".J_Mask_"+c.id);d.on("mouseover mouseout",function(a){a.type=="mouseover"?(f.show(),g.show()):(f.hide(),g.hide())}),f.data("data-file",c),f.on("click",b._delHandler,b)},_getStatusWrapper:function(a){return a&&a.children(".J_FileStatus")||e("")},_renderFiledrop:function(){var a=this,b=a.get("button"),c=b.get("target"),d=a.get("oPlugin").filedrop,e;return d?(e=new d({target:c,uploader:this.get("uploader"),tpl:{supportDrop:'<div class="drop-wrapper"></div>'}}),e.render(),e):!1},_waitingHandler:function(a){},_startHandler:function(a){var b=this,c=a.uploader,d=a.index,f=b.get("queue"),g=c.get("type"),h=e(".J_ProgressBar_"+a.id);if(g=="ajax"||g=="flash"){var i=b.get("oPlugin").progressBar,j;i&&(j=new i(h),j.on("change",function(a){a.value==100&&(j.hide(),b._setDisplayMsg(!1,a.file))}),j.render(),b.set("progressBar",j)),f.updateFile(d,{progressBar:j})}},_progressHandler:function(a){var b=a.file,c=a.loaded,d=a.total,e=Math.ceil(c/d*100),f=b.progressBar;if(!f)return!1;f.set("value",e)},_successHandler:function(a){var b=this,c=a.file,d=c.id,f=c.result,g=c.progressBar;b._setCount(),f&&b._changeImageSrc(a.id,f);if(!g)return e(".J_ProgressBar_"+d).hide(),b._setDisplayMsg(!1,a.file),!1;g.set("value",100),e(".J_Mask_"+d).hide()},_errorHandler:function(b){var c=this,d=b.msg,f=b.id;e(".J_ErrorMsg_"+f).html(d),c._setDisplayMsg(!0,b.file),a.log(d)},_setCount:function(){var a=this,b=e(a.get("elCount")),c=a.getFilesLen(),d=a.get("auth");if(!d)return!1;var f=d.get("rules"),g=f.max;if(!g)return!1;b.length&&b.text(g[0]-c)},_setDisplayMsg:function(a,b){if(!b)return!1;var c=e(".J_Mask_"+b.id);c[a&&"show"||"hide"](),a?c.show():c.hide()},_delHandler:function(a){var b=this,c=b.get("uploader"),d=b.get("queue"),f=e(a.target).data("data-file"),g=d.getFileIndex(f.id),h=f.status;(h=="start"||h=="progress")&&c.cancel(g),b._setCount()},getFilesLen:function(a){a||(a="success");var b=this,c=b.get("queue"),d=c.getFiles(a);return d.length},_changeImageSrc:function(b,c){var f=c.data,g,h=e(".J_Pic_"+b);if(!a.isObject(f))return!1;g=f.url,h.attr("src")==d&&(h.show(),h.attr("src",g))}},{ATTRS:{name:{value:"imageUploader"},cssUrl:{value:"gallery/form/1.2/uploader/themes/imageUploader/style.css"},fileTpl:{value:'<li id="queue-file-{id}" class="clearfix" data-name="{name}"><div class="tb-pic120"><a href="javascript:void(0);"><img class="J_Pic_{id}" src="" /></a></div><div class=" J_Mask_{id} pic-mask"></div><div class="status-wrapper J_FileStatus"><div class="status waiting-status tips-upload-waiting"><p class="tips-text">\u7b49\u5f85\u4e0a\u4f20\uff0c\u8bf7\u7a0d\u5019</p></div><div class="status start-status progress-status success-status tips-uploading"><div class="J_ProgressBar_{id}"><s class="loading-icon"></s>\u4e0a\u4f20\u4e2d...</div></div><div class="status error-status tips-upload-error"><p class="J_ErrorMsg_{id} tips-text">\u4e0a\u4f20\u5931\u8d25\uff0c\u8bf7\u91cd\u8bd5\uff01</p></div></div><a class="J_Del_{id} del-pic" href="#">\u5220\u9664</a></li>'},plugins:{value:["progressBar","filedrop"]},elCount:{value:"#J_UploadCount"},isMaxHideBtn:{value:!0}}}),f},{requires:["node","../../theme"]});